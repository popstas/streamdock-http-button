# StreamDock HTTP Button Plugin

Плагин для StreamDock, который отображает содержимое Markdown файла в виде кнопок и отправляет HTTP POST запросы при нажатии на кнопки.

## Основная функциональность

Плагин позволяет:
- **Отображать содержимое MD файла** - каждая строка MD файла отображается как отдельная кнопка на StreamDock
- **Генерировать SVG изображения** - автоматически создает изображения кнопок из содержимого MD файла с поддержкой многострочного текста
- **Отправлять HTTP запросы** - при нажатии на кнопку отправляется POST запрос на настроенный URL с содержимым соответствующей строки из MD файла

## Архитектура проекта

### Основные компоненты

1. **`src/plugin/index.vue`** - главный компонент плагина
   - Регистрирует обработчики событий StreamDock
   - Загружает action handlers из `src/plugin/actions/`

2. **`src/plugin/actions/httpButton.ts`** - обработчик действия HTTP Button
   - Загружает MD файл и генерирует SVG изображение кнопок
   - Отслеживает изменения MD файла (каждые 2 секунды)
   - Обрабатывает нажатия кнопок и отправляет HTTP запросы
   - Определяет индекс нажатой кнопки по координатам или настройкам

3. **`src/pages/actions/httpButton.vue`** - интерфейс настроек в Property Inspector
   - Настройка пути к MD файлу (относительно `public/`)
   - Настройка URL для HTTP запросов

4. **`src/manifest.cjs`** - манифест плагина
   - UUID плагина: `pro.popstas.httpbutton`
   - UUID действия: `httpButton`
   - Конфигурация локализации (en, zh_CN)

### Технологический стек

- **Vue 3** + **TypeScript** - основной фреймворк
- **Pinia** - управление состоянием
- **Naive UI** - компоненты интерфейса
- **Vite** - сборка проекта
- **Tailwind CSS** - стилизация
- **vite-plugin-singlefile** - упаковка в один HTML файл

### Структура данных

**Настройки действия (Settings):**
```typescript
{
  mdFilePath?: string;  // Путь к MD файлу (по умолчанию: 'text.md')
  httpUrl?: string;     // URL для HTTP POST запроса
  buttonIndex?: number; // Индекс кнопки (опционально)
}
```

**HTTP запрос при нажатии:**
```json
{
  "path": "<содержимое строки из MD файла>",
  "value": "<содержимое строки из MD файла>"
}
```

### Логика работы

1. **Инициализация действия (`willAppear`):**
   - Загружается MD файл
   - Генерируется SVG изображение со всеми строками из файла
   - Запускается таймер для отслеживания изменений файла (каждые 2 секунды)

2. **Обработка нажатия (`keyUp`/`touchTap`):**
   - Определяется индекс нажатой кнопки:
     - Из настроек (`settings.buttonIndex`)
     - Или вычисляется из координат: `row * 5 + column + 1`
   - Загружается актуальное содержимое MD файла
   - Выбирается строка по индексу
   - Отправляется POST запрос с содержимым строки

3. **Генерация SVG:**
   - Каждая строка MD файла становится отдельной строкой текста в SVG
   - Текст центрируется и отображается многострочно
   - Исключаются пустые строки и строки, начинающиеся с "button content:"

### Файловая структура

```
streamdock-http-button/
├── public/              # Публичные ресурсы (копируются в dist/)
│   ├── images/         # Иконки плагина
│   ├── text.md         # Пример MD файла с кнопками
│   └── interval.js     # Worker для таймеров
├── src/
│   ├── components/     # Vue компоненты
│   ├── hooks/          # Композиционные функции (plugin, property, i18n)
│   ├── plugin/         # Логика плагина
│   │   ├── actions/    # Обработчики действий
│   │   └── index.vue   # Главный компонент плагина
│   ├── pages/          # Страницы Property Inspector
│   │   └── actions/    # Страницы настроек действий
│   ├── types/          # TypeScript определения
│   └── manifest.cjs    # Манифест плагина
├── script/             # Скрипты сборки
└── dist/               # Собранный плагин (автоматически копируется в StreamDock)
```

### Особенности реализации

- **Отслеживание изменений MD файла**: Плагин периодически проверяет MD файл на изменения (каждые 2 секунды) и обновляет изображение кнопок
- **Определение индекса кнопки**: Использует координаты нажатия (row/column) для вычисления номера кнопки в сетке 5x5
- **Кэширование содержимого**: Предотвращает лишние обновления, сравнивая содержимое файла
- **XML экранирование**: Корректно обрабатывает спецсимволы в тексте при генерации SVG

### Команды разработки

- `npm run dev` - запуск dev сервера с автоматической копией в StreamDock
- `npm run build` - сборка плагина для продакшена
- `npm start` - предпросмотр собранного плагина

### Формат MD файла

Каждая непустая строка (кроме начинающихся с "button content:") становится отдельной кнопкой:

```
lights/on
lights/off
fan/speed/high
fan/speed/low
```

При нажатии на первую кнопку будет отправлен POST запрос с `{"path": "lights/on", "value": "lights/on"}`.






